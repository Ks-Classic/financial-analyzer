# プロジェクト概要: AI財務レポートアナライザー

## 1. 目的
本プロダクトは、財務レポート作成担当者が作成したレポートの品質を向上させることを目的とする。具体的には、人間が担当する煩雑な数字や計算の確認、記述と数値の矛盾検出、重要な情報の見落としチェックをAIが代行する。これにより、レポートの正確性を高め、担当者の作業負担を軽減し、最終的なレビュープロセスを効率化する。

## 2. ペルソナ
### 財務レポート作成担当者 (ターゲットユーザー)
*   **名前**: 佐藤 健太
*   **年齢**: 30代
*   **役職**: 企業の経理部または財務部の担当者
*   **背景**: 毎月、四半期ごとに財務レポートを作成している。手作業での数値チェックや記述確認に時間を要しており、見落としやミスが発生するリスクに悩んでいる。上司からの詳細なレビューと修正指示に疲弊している。
*   **ニーズ**:
    *   迅速かつ高精度なレポートチェック機能
    *   修正すべき箇所とその理由が明確に提示されること
    *   修正作業を効率化するヒントやツール
*   **目標**: 上司からの修正指示を減らし、レポート作成業務の品質と効率を高める。

## 3. ユーザーフロー
### 財務レポートの分析
1.  **PDFファイルのアップロード**: ユーザーはウェブアプリケーションのUIから、チェックしたい財務レポートのPDFファイルをアップロードする。
2.  **PDFの表示と初期処理**: アップロードされたPDFはウェブアプリケーションのビューアに表示され、同時にバックエンドへストリーミングされる。バックエンドはPDFを解析し、テキストデータをメモリ上で抽出し、処理後即座に破棄する。
3.  **AIによる分析**: 抽出されたテキストデータはAIモデル（Google Gemini）に送信され、指定された観点（数値計算の誤り、傾向の誤り、事実誤認、重要項目の見落とし）で分析される。
4.  **分析結果の受信と保存**: AIからの分析結果はウェブアプリケーションに返される前に、Firestoreに保存される。PDFファイル自体は保存しない。
5.  **分析結果の表示**: ウェブアプリケーションは分析結果を受け取り、PDFビューアの隣にリスト形式で表示する。各指摘事項はページ番号、指摘の種類、サマリー、詳細、ハイライトテキストを含む。
6.  **指摘箇所の確認**: ユーザーは表示された分析結果リストをスクロールし、各指摘事項をクリックすることで、関連するPDFページへ移動し、クライアント側で保持しているPDFデータに対し、指摘されたテキストがハイライト表示されることを確認する。
7.  **修正作業の実施**: ユーザーは分析結果を参考に、財務レポートの修正を行う。将来的に修正チェックリスト機能が追加され、修正進捗の管理が可能になる。

## 4. 画面構成
### 概要
主要な画面は単一のページで構成され、PDFファイルのアップロードから分析結果表示まで一連の流れを提供する。PDF表示機能は削除され、分析結果の表示に特化したシンプルなUIとなっている。

```
+-------------------------------------------------------------------+
| ヘッダー (AI財務レポートアナライザー)                             |
+-------------------------------------------------------------------+
| メインエリア                                                      |
| +---------------------------------------------------------------+ |
| | ファイルアップロード (PDF選択、分析開始ボタン)                | |
| +---------------------------------------------------------------+ |
| +---------------------------------------------------------------+ |
| | ローディング/エラー/完了メッセージ                            | |
| +---------------------------------------------------------------+ |
| +---------------------------------------------------------------+ |
| | 分析結果表示エリア (独立したスクロール機能付き)               | |
| | - ページタイトル、指摘事項、詳細がカード形式で表示            | |
| | - 種類別の色分け表示                                          | |
| | - ハイライトテキストの表示                                    | |
| +---------------------------------------------------------------+ |
+-------------------------------------------------------------------+
| フッター (著作権情報)                                             |
+-------------------------------------------------------------------+
```

### コンポーネント詳細
*   **ヘッダー**: プロダクト名「AI財務レポートアナライザー」を表示する。
*   **ファイルアップロード**: PDFファイルをドラッグアンドドロップまたはファイル選択でアップロードするエリアと、分析開始ボタン。「分析中...」「再分析する」などの状態表示も行う。
*   **ローディング/エラー/完了メッセージ**: 分析プロセス中の状態（ローディング、エラー、完了）をユーザーに通知する。
*   **分析結果表示エリア**:
    *   AIが指摘した問題点をカード形式で表示する。
    *   各項目はページタイトル、ページ番号、指摘の種類、サマリー、詳細、関連テキスト（ハイライトテキスト）を含む。
    *   独立したスクロール機能により、多数の分析結果を効率的に閲覧できる。
    *   指摘の種類に応じた色分けにより、視認性を向上させる。
    *   レスポンシブデザインによりモバイル・デスクトップ両方に対応。

## 5. 機能要件
### FR1. PDFファイルアップロード機能
*   ユーザーは財務レポートのPDFファイルをウェブUIから選択し、アップロードできる。
*   アップロード可能なファイル形式はPDFのみとする。
*   大容量のPDFファイルにも対応する（最大100MB程度）。

### FR2. 分析結果表示機能
*   AI分析結果をカード形式でわかりやすく表示できる。
*   各指摘事項は種類別に色分けされ、視認性が高い。
*   独立したスクロール機能により、多数の結果を効率的に閲覧できる。
*   レスポンシブデザインによりモバイル・デスクトップ両方で最適な表示を提供する。

### FR3. AI分析機能
*   アップロードされたPDFからテキストデータを抽出し、Google Gemini AIモデルに送信する。PDFデータはサーバー側で永続的に保存されず、処理後に即座にメモリから破棄される。
*   AIは以下の観点でレポートを分析し、結果をJSON形式で返す。
    *   数値計算の誤り
    *   傾向の誤り（記述と数値の矛盾）
    *   事実誤認（レポート内の他箇所との矛盾）
    *   重要項目の見落とし
*   AIの分析結果には、指摘箇所のページ番号、ページタイトル、種類、サマリー、詳細、関連テキスト（ハイライト用）が含まれる。

### FR4. エラーハンドリング機能
*   ファイルアップロード時のエラー（形式、サイズなど）を適切にユーザーに通知する。
*   AI分析中のエラーに対してわかりやすいメッセージを表示する。
*   処理状況をリアルタイムでユーザーに通知する（ローディング表示など）。

### FR5. (将来的な拡張) 修正チェックリスト機能
*   分析結果に基づき、修正が必要な項目をチェックリストとして管理できる。
*   各項目に対し、完了/未完了のステータスを設定できる。

## 6. 非機能要件
### 性能
*   **応答速度**: PDFアップロードから分析結果表示まで、平均5秒以内（PDFのサイズに依存）。
*   **同時実行性**: 複数ユーザーからの同時分析リクエストに対応できる（例: 5リクエスト/秒）。
*   **スケーラビリティ**: Cloud Runの自動スケーリングにより、負荷に応じてリソースが自動的に拡張される。

### 信頼性
*   **可用性**: フロントエンド、バックエンドともに高い可用性（99.9%以上）を維持する。
*   **耐障害性**: 各コンポーネントは独立して動作し、一部の障害がシステム全体に波及しない設計とする。
*   **データ永続性**: 分析結果はFirestoreに保存され、永続性が確保される。

### 運用性
*   **デプロイ**: TerraformとCLI（gcloud CLI, Vercel CLI）を用いた自動デプロイプロセスを確立する。
*   **監視**: 各サービスのリソース使用率、エラー率、応答速度などを監視し、異常を検知できる。
*   **ロギング**: 各サービスからのログを集中管理し、問題発生時の原因特定を容易にする。

### セキュリティ
*   **認証・認可**: 将来的にユーザー認証機能を導入し、適切な認可を行う。
*   **データ保護**: 分析結果データはFirestoreにセキュアに保存される。アップロードされたPDFファイルはサーバー側で永続的に保存されず、処理後に即座にメモリから破棄される。
*   **APIキー管理**: AIモデルのAPIキーは環境変数として安全に管理される。
*   **通信の暗号化**: フロントエンドとバックエンド間の通信はHTTPSで暗号化される。

### 拡張性
*   **AIモデルの変更**: 将来的なAIモデルの変更や追加に柔軟に対応できる設計とする。
*   **機能追加**: 修正チェックリスト、ユーザー管理など、将来的な機能拡張が容易な構造とする。
*   **マイクロサービス**: 各サービスは独立しており、機能追加や改修が他のサービスに影響を与えにくい。

## 7. システムアーキテクチャ
本プロダクトは、モノレポ構成のフロントエンド、バックエンド、共有型定義パッケージから構成され、Google Cloud Platform (GCP) とVercelを組み合わせたハイブリッドクラウドアーキテクチャを採用する。

```
+--------------------------------------------------------------------------------------------------------+
|                                              ユーザー                                                  |
+--------------------------------------------------------------------------------------------------------+
        |
        | HTTPS
        V
+--------------------------------------------------------------------------------------------------------+
|                                           Vercel (Frontend)                                            |
|                                     (Next.js App Router)                                               |
|                                            (HTML, CSS, JS)                                             |
+--------------------------------------------------------------------------------------------------------+
        |
        | API Call (HTTPS)
        V
+--------------------------------------------------------------------------------------------------------+
|                                            GCP (Backend)                                               |
| +----------------------------------------------------------------------------------------------------+ |
| |                         Cloud Run (API Service)                                                    | |
| |                           (Node.js/Express, pdf-parse, @google/generative-ai)                      | |
| |                                                                                                    | |
| +----------------------------------------------------------------------------------------------------+ |
|                                                                                                        |
|                                            +---------------------+                                   |
|                                            | Firestore           |                                   |
|                                            | (分析結果、ユーザーデータ) |                                   |
|                                            +---------------------+                                   |
+--------------------------------------------------------------------------------------------------------+
```

### アーキテクチャの解説
*   **モノレポ構成**:
    *   `apps/frontend`: Next.js App Routerを使用したフロントエンドアプリケーション。UIの表示、PDFアップロード、分析結果の表示を担う。Vercelにデプロイされる。
    *   `apps/backend`: Node.js/Expressを使用したバックエンドアプリケーション。PDFファイルの受信、解析、AI分析の実行、分析結果の保存、APIとしての提供を担う。Cloud Run (API Service) にデプロイされる。PDFデータはメモリ上で処理され、永続的に保存されない。
    *   `packages/types`: フロントエンドとバックエンドで共有される型定義（TypeScriptインターフェース）を格納するパッケージ。
*   **フロントエンド (Vercel)**:
    *   Next.js App Routerを使用し、高速な初期表示とSEO対応を実現する。
    *   Vercel CLIを用いたデプロイにより、迅速なリリースサイクルを確立する。
    *   Tailwind CSSとshadcn/uiを用いて、モダンでレスポンシブなUIを構築する。
*   **バックエンド (GCP Cloud Run)**:
    *   API Service: フロントエンドからのリクエストを受け付け、PDF解析とAI分析の実行、結果の返却を行う。`pdf-parse`でPDFテキストを抽出し、Google Gemini APIと連携する。PDFデータはメモリ上で処理され、即座に破棄される。
    *   GCP CLIを用いたデプロイにより、インフラのコード化と自動化を推進する。
*   **データストア**:
    *   **Firestore**: AIによる分析結果や、将来的に実装されるユーザーデータ、修正チェックリストなどの構造化されたデータを永続的に保存する。NoSQLデータベースであり、柔軟なデータモデルと高いスケーラビリティを提供する。
*   **メッセージング・タスクキュー (将来的な拡張)**:
    *   **Pub/Sub**: 大規模なPDF処理や非同期処理が必要になった場合に検討する。
    *   **Cloud Tasks**: 長時間実行されるタスク（大規模PDFの分析など）を確実に実行するためのタスクキューとして利用を検討する。

### 技術スタック
*   **言語**: TypeScript
*   **フロントエンドフレームワーク**: Next.js (App Router)
*   **UIライブラリ**: React, Tailwind CSS, shadcn/ui
*   **バックエンドフレームワーク**: Node.js, Express
*   **PDF解析ライブラリ**: pdf-parse
*   **AIモデル**: Google gemini-2.5-pro-preview-06-05
*   **インフラ自動化**: Terraform
*   **デプロイツール**: gcloud CLI (GCP), Vercel CLI (Vercel)
*   **パッケージマネージャ**: pnpm (モノレポ管理)

## 8. API 仕様
### 8.1. PDF分析API
*   **エンドポイント**: `/api/analyze`
*   **メソッド**: `POST`
*   **リクエスト**:
    *   `Content-Type`: `multipart/form-data`
    *   `body`:
        *   `pdf`: `File` (財務レポートPDFファイル)
*   **レスポンス**:
    *   `Content-Type`: `application/json`
    *   `status`: `200 OK`
    *   `body`:
        ```json
        {
          "analysisResults": [
            {
              "page": 2,
              "pdfPhysicalPageNumber": 2,
              "pageTitle": "主要な財務指標",
              "type": "数値計算の誤り",
              "summary": "売上総利益の計算が不一致",
              "details": "損益計算書に記載の売上総利益（1,230百万円）は、売上高（2,000百万円）から売上原価（766百万円）を差し引いた計算結果（1,234百万円）と一致しません。",
              "highlightText": "1,230百万円"
            }
          ]
        }
        ```
    *   `status`: `400 Bad Request` または `500 Internal Server Error`
    *   `body`:
        ```json
        {
          "error": "エラーメッセージ"
        }
        ```
*   **エラーハンドリング**:
    *   PDFファイルがアップロードされない、または無効な形式の場合: 400 Bad Request
    *   PDF解析またはAI分析中にエラーが発生した場合: 500 Internal Server Error

## 9. DB スキーマ
本プロダクトはFirestoreを主要なデータストアとして利用する。以下に主要なコレクションとドキュメントの構造を示す。

### `analysisResults` コレクション
*   **目的**: アップロードされたPDFの分析結果を保存する。
*   **ドキュメントID**: 自動生成される一意のID
*   **フィールド**:
    *   `pdfFileName`: `string` - 分析対象となったPDFのファイル名
    *   `pdfPageCount`: `number` - 分析対象となったPDFの総ページ数
    *   `timestamp`: `Timestamp` - 分析が実行された日時
    *   `results`: `Array<AnalysisResult>` - AI分析によって生成された`AnalysisResult`オブジェクトの配列。`AnalysisResult`の型は`@repo/types`で定義されているものに従う。
        ```ts
        interface AnalysisResult {
          page: number;
          pdfPhysicalPageNumber?: number;
          pageTitle?: string; // そのページの主要なタイトル。特定できない場合は空文字列。
          type: '数値計算の誤り' | '傾向の誤り' | '事実誤認' | '重要項目の見落とし' | 'その他';
          summary: string;
          details: string;
          highlightText?: string;
        }
        ```

### `users` コレクション (将来的な拡張)
*   **目的**: ユーザー認証が導入された際のユーザー情報を保存する。
*   **ドキュメントID**: ユーザーの一意なID (例: Firebase AuthenticationのUID)
*   **フィールド**:
    *   `email`: `string` - ユーザーのメールアドレス
    *   `displayName`: `string` - ユーザーの表示名
    *   `createdAt`: `Timestamp` - ユーザーが作成された日時
    *   `lastLoginAt`: `Timestamp` - 最終ログイン日時

### `checklists` コレクション (将来的な拡張)
*   **目的**: 修正チェックリストの情報を保存する。
*   **ドキュメントID**: 自動生成される一意なID
*   **フィールド**:
    *   `analysisResultId`: `string` - 関連する`analysisResults`ドキュメントのID
    *   `userId`: `string` - チェックリストを作成したユーザーのID
    *   `items`: `Array<ChecklistItem>` - チェックリストの項目配列
        ```ts
        interface ChecklistItem {
          summary: string; // analysisResult.summary と同じ
          isCompleted: boolean; // 完了しているかどうかのフラグ
          notes?: string; // ユーザーが追加するメモ
        }
        ```
    *   `createdAt`: `Timestamp` - チェックリストが作成された日時
    *   `updatedAt`: `Timestamp` - チェックリストが最後に更新された日時

## 10. DoD (Definition of Done)
以下の全てを満たした場合に、タスクが完了と定義される。

*   要件が完全に理解され、設計ドキュメントに反映されている。
*   コードが実装され、単体テストが記述されている。
*   全てのテストケースがパスしている。
*   コードレビューが完了し、指摘事項が修正されている。
*   Linterおよびフォーマッターのチェックをパスしている。
*   関連するドキュメント（開発仕様書、APIドキュメント、READMEなど）が更新されている。
*   CI/CDパイプライン上で自動デプロイが成功している。
*   本番環境へのリリース準備が完了している。
*   ユーザーからのフィードバックが収集され、必要に応じて対応が計画されている。
*   全てのTODO項目が解消されている。 