# PDFエクスポート機能 500エラー 調査・解決タスクリスト

**ステータス:** 調査中

## 根本原因の仮説

1.  **[最有力] 修正コードのデプロイ不備:**
    *   `pdf-export.service.ts` に加えた修正が、Google Cloud Runの本番環境にまだ正しくデプロイされていない、またはビルドに失敗している。

2.  **[次点] Cloud Run 実行環境の問題:**
    *   Cloud Runの実行環境に、`puppeteer` が必要とするシステムライブラリ（フォント関連など）が不足している。`executablePath` の指定だけでは不十分なケース。

3.  **[要確認] 権限の問題:**
    *   Cloud Runのサービスアカウントに、一時ファイルの作成や読み書きに必要な権限が付与されていない。

4.  **[可能性低] データ起因の問題:**
    *   フロントエンドから送信される特定の分析結果データ（例: 特殊文字、巨大なデータ）が、バックエンドのHTML生成またはPDF変換処理でエラーを引き起こしている。

5.  **[可能性低] タイムアウト:**
    *   PDFの生成処理が、Cloud Runで設定されているデフォルトのタイムアウト（例: 300秒）を超過している。

## 検証ステップと結果ログ

### フェーズ1: デプロイとログの確認

-   [x] **タスク1: バックエンドのデプロイ状況の最終確認**
    -   **目的:** 修正が加えられた最新のコードが、意図したCloud Runサービスに正常にデプロイされているかをコマンドで確認する。
    -   **方法:** `gcloud run services describe` コマンドを使用し、最新のデプロイリビジョンと状態を確認する。
    -   **結果:** 正常にデプロイされ、最新リビジョンがトラフィックを受け付けていることを確認。デプロイ自体は成功している。
    -   **次のアクション:** サーバーサイドのログを確認する。

-   [x] **タスク2: Cloud Runの実行ログの直接確認**
    -   **目的:** 500エラー発生時の、バックエンド（サーバーサイド）の具体的なエラーログを特定する。
    -   **方法:** Google Cloudコンソールのログを確認。
    -   **結果:** `Error: Browser was not found at the configured executablePath` を特定。原因は、Cloud Run環境内でPuppeteerがChromeブラウザを見つけられないことだと判明。
    -   **次のアクション:** **仮説2「Cloud Run 実行環境の問題」**が根本原因であると断定。Dockerfileを修正し、Puppeteerが必要とする依存ライブラリをインストールする。

### フェーズ2: 環境と設定の検証

-   [x] **タスク3: Dockerfileの修正と再デプロイ**
    -   **目的:** `puppeteer` が必要とする依存ライブラリをコンテナ環境にインストールし、実行環境起因の問題を解消する。
    -   **方法:** `pdf-export.service.ts` から `executablePath` の指定を削除し、`Dockerfile` に依存ライブラリを追加してデプロイ。
    -   **結果:** 失敗。ログから `Error: Could not find Chrome` を確認。原因は、PuppeteerのキャッシュディレクトリがCloud Run環境で不正なパス (`/nonexistent/.cache/puppeteer`) を指しており、ブラウザ自体が見つけられないためと判明。
    -   **次のアクション:** Dockerfileを再度修正し、Puppeteerのキャッシュディレクトリを書き込み可能な場所に変更する。また、原因特定を容易にするため、デバッグログをコードに追加する。

-   [x] **タスク4: Dockerfileの修正とデバッグログの追加**
    -   **目的:** Puppeteerのキャッシュディレクトリを明示的に指定し、ブラウザが確実にインストール・配置されるようにする。
    -   **方法:** `Dockerfile` に環境変数 `PUPPETEER_CACHE_DIR` を設定してデプロイ。
    -   **結果:** 失敗。ビルドログから `COPY failed: stat app/.puppeteer_cache: file does not exist` を確認。原因は、`pnpm install` 時にブラウザがダウンロードされず、キャッシュディレクトリが作成されなかったため。
    -   **次のアクション:** Dockerfileを再度修正し、キャッシュディレクトリの作成とブラウザのインストールを強制的に実行する。

-   [x] **タスク5: Dockerfileの修正**
    -   **目的:** ブラウザのインストールを確実に行う。
    -   **方法:** `mkdir`と`pnpm exec`コマンドでブラウザインストールを強制。
    -   **結果:** 失敗。ビルドログから `COPY failed: stat app/.puppeteer_cache: file does not exist` を再確認。原因は、`pnpm install`時にブラウザがダウンロードされないという根本問題が未解決なため。
    -   **次のアクション:** 環境変数や個別コマンドに頼る方法を完全に破棄。Puppeteer公式の構成ファイル`.puppeteerrc.cjs`を使用し、ブラウザのインストール場所と動作を完全に制御する最終手段に切り替える。

-   [x] **タスク6: 【最終手段】Puppeteer構成ファイルを用いたDockerfileの全面改修**
    -   **目的:** Puppeteerの動作を公式の構成ファイルで完全に制御する。
    -   **方法:** `.puppeteerrc.cjs` を作成し、Dockerfileを全面改修してデプロイ。
    -   **結果:** 失敗。ビルドは成功したが、実行時に `Error: Failed to launch the browser process!` が発生。原因は、Cloud Runの実行環境とChromeの間に深刻な非互換性があるためと断定。
    -   **次のアクション:** Puppeteerの起動引数を、Cloud Runのような制限の多いコンテナ環境に最適化する。

-   [ ] **タスク7: 【最終確定版】Puppeteer起動引数の最適化**
    -   **目的:** Cloud Runの実行環境との非互換性を解消し、ブラウザを正常に起動させる。
    -   **方法:** `pdf-export.service.ts` の `puppeteer.launch` の `args` に、コンテナ環境で安定動作させるためのフラグ (`--disable-gpu`, `--disable-dev-shm-usage`, `--no-zygote` など) を追加する。
    -   **結果:**
    -   **次のアクション:** これで解決しない場合、Puppeteerのバージョンをダウングレードするか、Cloud Runの実行環境を第1世代に変更することを検討する。
