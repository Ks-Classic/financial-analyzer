# 財務コメント自動生成機能 - ユーザーフロー詳細

## 1. 全体フロー概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           全体ワークフロー                                   │
└─────────────────────────────────────────────────────────────────────────────┘

【Phase 1: MVP - 手動フロー】

  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
  │  Excel │──→│  シート │──→│  範囲  │──→│  月確認 │──→│  生成  │──→│ コピー │
  │ アップ │   │  選択  │   │  選択  │   │        │   │        │   │ →パワポ│
  └────────┘   └────────┘   └────────┘   └────────┘   └────────┘   └────────┘
                                                          │
                                                          ▼
                                                    ┌────────┐
                                                    │  編集  │
                                                    │(任意)  │
                                                    └────────┘

【Phase 2: テンプレート活用フロー】

  ┌────────┐   ┌────────┐   ┌────────────┐   ┌────────┐   ┌────────┐
  │  顧客  │──→│  Excel │──→│ テンプレート│──→│  生成  │──→│ コピー │
  │  選択  │   │ アップ │   │  自動適用   │   │        │   │ →パワポ│
  └────────┘   └────────┘   └────────────┘   └────────┘   └────────┘
                                 │
                            (初回のみ)
                                 ▼
                           ┌────────┐
                           │テンプレ│
                           │設定保存│
                           └────────┘
```

---

## 2. Phase 1 詳細フロー

### 2.1 コメント生成 基本フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 1: アプリアクセス                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  アプリにアクセス ──────────────────→ トップページ表示                     │
│                                        [レポートチェック | コメント生成]     │
│                                                                             │
│  「コメント生成」クリック ───────────→ コメント生成画面表示                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 2: Excelアップロード                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  Excelファイルをドラッグ＆ドロップ ──→ ファイル受信                        │
│                         または         ↓                                   │
│  「ファイル選択」クリック              バリデーション                       │
│         ↓                              ・形式チェック（xlsx/xls）           │
│  ファイル選択ダイアログ                ・サイズチェック（50MB以下）         │
│         ↓                              ↓                                   │
│  ファイル選択                          xlsxライブラリでパース               │
│                                        ↓                                   │
│                  ←─────────────────── シート一覧表示                       │
│                                        ・シート名                           │
│                                        ・行数・列数                         │
│                                                                             │
│  【エラー時】                                                               │
│  無効なファイル ────────────────────→ エラーメッセージ表示                 │
│                                        「xlsxまたはxlsファイルを選択して    │
│                                         ください」                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 3: シート選択                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  シート一覧から対象シートをクリック ─→ 選択状態に変更                      │
│                                        ↓                                   │
│                  ←─────────────────── シートプレビュー表示                 │
│                                        ・スプレッドシート形式               │
│                                        ・スクロール可能                     │
│                                        ・行番号・列名表示                   │
│                                                                             │
│  【複数シート確認時】                                                       │
│  別のシートをクリック ──────────────→ プレビュー切り替え                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 4: 範囲選択                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「範囲選択モード」ボタンクリック ───→ 範囲選択モードに切り替え            │
│                                        ・カーソルが十字に変化              │
│                                        ・選択ガイド表示                    │
│                                                                             │
│  表の左上セルでマウスダウン ─────────→ 選択開始位置を記録                  │
│         │                                                                   │
│         ▼                                                                   │
│  表の右下セルまでドラッグ ───────────→ 選択範囲をリアルタイム表示          │
│         │                              ・半透明の青色オーバーレイ          │
│         ▼                              ・選択範囲の行・列数表示            │
│  マウスアップ ───────────────────────→ 範囲確定                            │
│                                        ・枠線でハイライト                  │
│                                        ・選択範囲情報表示                  │
│                                          「A2:L44 (43行 × 12列)」          │
│                                                                             │
│  【範囲修正時】                                                             │
│  再度ドラッグ ───────────────────────→ 範囲を上書き                        │
│                                                                             │
│  【複数範囲選択時（Phase 2）】                                              │
│  Ctrlを押しながらドラッグ ───────────→ 追加範囲として記録                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 5: 月列確認                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  システム（自動処理）                                                       │
│  ──────（──────────）                                                       │
│  選択範囲のヘッダー行をスキャン                                             │
│         ↓                                                                   │
│  月パターン（YYMM等）を検出                                                 │
│         ↓                                                                   │
│  最新月・前月を特定                                                         │
│         ↓                                                                   │
│  検出結果を表示 ─────────────────────→ ユーザーに確認                      │
│                                                                             │
│  ┌──────────────────────────────────────────┐                              │
│  │ 📅 月列を検出しました                    │                              │
│  │                                          │                              │
│  │ 検出月: 2501, 2502, 2503, 2504, 2505, 2506                              │
│  │ 最新月: 2506 (L列)                       │                              │
│  │ 前月:   2505 (K列)                       │                              │
│  │                                          │                              │
│  │ [OK] [手動で設定]                        │                              │
│  └──────────────────────────────────────────┘                              │
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「OK」クリック ─────────────────────→ 検出結果を確定、次のステップへ      │
│                                                                             │
│  「手動で設定」クリック ─────────────→ 手動設定UI表示                      │
│                                        ・ヘッダー行選択                    │
│  ヘッダー行を選択 ───────────────────→ ・月形式選択（YYMM等）              │
│  最新月列を選択 ─────────────────────→ ・比較対象月列選択                  │
│  「確定」クリック ───────────────────→ 手動設定を確定                      │
│                                                                             │
│  【検出失敗時】                                                             │
│                  ←─────────────────── エラーメッセージ                     │
│                                        「月情報を検出できませんでした」     │
│                                        手動設定UIを自動表示                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 6: コメント生成                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│                  ←─────────────────── コメント生成画面表示                 │
│                                        ・表プレビュー(選択範囲)             │
│                                        ・コメント設定エリア                 │
│                                                                             │
│  コメントモード選択                                                         │
│  ○ お任せ ─────────────────────────→ 全項目を自動分析対象                 │
│  ● 項目指定 ────────────────────────→ 項目選択UIを表示                     │
│                                                                             │
│  【項目指定モードの場合】                                                   │
│  対象項目をチェック                                                         │
│  ☑ 売上高                                                                   │
│  ☑ 売上原価                                                                 │
│  ☐ 販管費                                                                   │
│  ☐ 営業利益 ────────────────────────→ 選択項目を記録                       │
│                                                                             │
│  「コメント生成」ボタンクリック ─────→ ローディング表示                    │
│                                        ↓                                   │
│                                        選択範囲データを抽出                │
│                                        ↓                                   │
│                                        APIリクエスト作成                   │
│                                        ↓                                   │
│                                        Gemini APIに送信                    │
│                                        ↓                                   │
│                                        レスポンス受信                      │
│                                        ↓                                   │
│                  ←─────────────────── コメント表示                         │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ 生成コメント:                                                        │  │
│  │                                                                      │  │
│  │ ・売上高                                                             │  │
│  │   5月は単価が増加したものの、ミラクルフィットⅠ（片側）や            │  │
│  │   ミラクルフィットⅤ（コバルト）等の販売個数が減少したことにより、  │  │
│  │   売上高は対前月比で減少している。                                  │  │
│  │                                                                      │  │
│  │ ・入会金収入                                                         │  │
│  │   MD会員からの入会金である。2月の10万円はグレードアップ会員から    │  │
│  │   の入会金であり...                                                  │  │
│  │                                                                      │  │
│  │ [📋 コピー]                                        [✏️ 編集]        │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  【エラー時】                                                               │
│                  ←─────────────────── エラーメッセージ                     │
│                                        「コメント生成に失敗しました」       │
│                                        [リトライ] ボタン表示                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 7: コメント編集（任意）                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「編集」ボタンクリック ─────────────→ テキストエリアを編集可能に          │
│         │                                                                   │
│         ▼                                                                   │
│  コメントを編集                                                             │
│  ・文言修正                                                                 │
│  ・追記                                                                     │
│  ・削除                                                                     │
│         │                                                                   │
│         ▼                                                                   │
│  編集完了（フォーカスアウト）────────→ 編集内容を保持                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 8: コピー＆パワポ貼り付け                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「コピー」ボタンクリック ───────────→ コメントをクリップボードにコピー    │
│                                        ↓                                   │
│                  ←─────────────────── 「コピーしました」トースト表示       │
│                                                                             │
│  パワポに切り替え                                                           │
│         ↓                                                                   │
│  Ctrl+V で貼り付け                     (パワポ側の操作)                    │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  「表をコピー」ボタンクリック ───────→ 選択範囲の表データをコピー          │
│                                        ↓                                   │
│                  ←─────────────────── 「表をコピーしました」トースト       │
│                                                                             │
│  パワポに切り替え                                                           │
│         ↓                                                                   │
│  Ctrl+V で貼り付け                     (パワポ側の操作)                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 9: 次のページへ（繰り返し）                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  別の範囲を選択 ─────────────────────→ Step 4 に戻る                       │
│                                                                             │
│  別のシートを選択 ───────────────────→ Step 3 に戻る                       │
│                                                                             │
│  新しいExcelをアップロード ──────────→ Step 2 に戻る                       │
│                                                                             │
│  作業完了 ───────────────────────────→ 画面を閉じる / 別機能へ             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Phase 2 詳細フロー（テンプレート活用）

### 3.1 テンプレート初回設定フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 初回: テンプレート設定                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「顧客管理」メニュー ───────────────→ 顧客一覧画面表示                    │
│                                                                             │
│  「新規顧客」クリック ───────────────→ 顧客登録フォーム表示                │
│         │                                                                   │
│         ▼                                                                   │
│  顧客名入力: ミラクルラボ ───────────→                                     │
│  「保存」クリック ───────────────────→ 顧客データ保存                      │
│                                        ↓                                   │
│                  ←─────────────────── ページ設定画面に遷移                 │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  「ページを追加」クリック ───────────→ ページ設定フォーム表示              │
│         │                                                                   │
│         ▼                                                                   │
│  ページ設定入力:                                                            │
│  ・ページ名: 損益計算書 (1/2)                                               │
│  ・ページタイプ: 損益計算書                                                 │
│  ・対応シート名: PL推移                                                     │
│         │                                                                   │
│         ▼                                                                   │
│  サンプルExcelをアップロード ────────→ シート表示                          │
│         │                                                                   │
│         ▼                                                                   │
│  範囲選択（Step 4と同様）────────────→ 範囲を記録                          │
│         │                                                                   │
│         ▼                                                                   │
│  月設定確認 ─────────────────────────→ 月フォーマット、検出設定を保存      │
│         │                                                                   │
│         ▼                                                                   │
│  コメント設定:                                                              │
│  ・モード: お任せ / 項目指定                                                │
│  ・対象項目: 売上高, 売上原価...                                            │
│  ・最大文字数: 500                                                          │
│  ・改行スタイル: 箇条書き                                                   │
│         │                                                                   │
│         ▼                                                                   │
│  「保存」クリック ───────────────────→ テンプレート保存                    │
│                                                                             │
│  20ページ分繰り返し...                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 月次作業フロー（テンプレート適用）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 月次: テンプレート適用によるコメント生成                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ユーザー                              システム                             │
│  ────────                              ──────────                           │
│  「コメント生成」メニュー ───────────→ コメント生成画面表示                │
│                                                                             │
│  顧客選択: [▼ ミラクルラボ] ─────────→ 顧客のテンプレート読み込み          │
│                                        ↓                                   │
│                  ←─────────────────── ページ一覧表示（20P）                │
│                                                                             │
│  Excelアップロード ──────────────────→ ファイル解析                        │
│                                        ↓                                   │
│                                        テンプレートに基づきマッピング      │
│                                        ↓                                   │
│                  ←─────────────────── マッピング結果表示                   │
│                                        ✅ P1: 損益計算書 → PL推移          │
│                                        ✅ P7: 技工士別 → 技工士            │
│                                        ⚠️ P11: シート未検出                 │
│                                                                             │
│  マッピング確認「OK」クリック ───────→ 範囲自動設定                        │
│                                        ↓                                   │
│                                        月列自動検出                        │
│                                        ↓                                   │
│                  ←─────────────────── 準備完了表示                         │
│                                                                             │
│  「全ページ生成」クリック ───────────→ 各ページのコメントを順次生成       │
│                                        ↓                                   │
│                                        プログレス表示                      │
│                                        「生成中... 3/20」                   │
│                                        ↓                                   │
│                  ←─────────────────── 全ページ生成完了                     │
│                                        各ページのコメント一覧表示          │
│                                                                             │
│  各ページのコメント確認・編集                                               │
│         ↓                                                                   │
│  「P1をコピー」クリック ─────────────→ P1のコメントをコピー                │
│         ↓                                                                   │
│  パワポに貼り付け                                                           │
│         ↓                                                                   │
│  「P2をコピー」クリック...                                                  │
│         ↓                                                                   │
│  全ページ完了                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. エラーハンドリングフロー

### 4.1 ファイルアップロードエラー

```
ユーザー                              システム
────────                              ──────────
PDFファイルをアップロード ────────────→ ファイル形式チェック
                                       ↓
                                       ❌ 非対応形式
                                       ↓
              ←─────────────────────── エラーダイアログ表示
                                       「xlsx または xls ファイルを
                                        アップロードしてください」
                                       [OK]
「OK」クリック ────────────────────────→ ダイアログを閉じる
                                       アップロードエリアに戻る
```

### 4.2 AI生成エラー

```
ユーザー                              システム
────────                              ──────────
「コメント生成」クリック ──────────────→ API リクエスト送信
                                       ↓
                                       ❌ APIエラー（タイムアウト等）
                                       ↓
              ←─────────────────────── エラーメッセージ表示
                                       「コメント生成に失敗しました」
                                       「ネットワーク接続を確認してください」
                                       [リトライ] [キャンセル]

「リトライ」クリック ──────────────────→ 再度APIリクエスト送信
                                       ↓
                                       ✅ 成功
                                       ↓
              ←─────────────────────── コメント表示
```

---

## 5. 状態遷移図

```
                    ┌─────────────────┐
                    │     初期状態     │
                    │  (何もなし)      │
                    └────────┬────────┘
                             │ Excelアップロード
                             ▼
                    ┌─────────────────┐
                    │  ファイル読込中  │
                    └────────┬────────┘
                             │ パース完了
                             ▼
          ┌─────────────────────────────────────┐
          │          シート選択待ち              │
          │  ・シート一覧表示                    │
          │  ・プレビュー表示可能                │
          └────────────────┬────────────────────┘
                          │ シート選択
                          ▼
          ┌─────────────────────────────────────┐
          │          範囲選択待ち                │
          │  ・シートプレビュー表示              │
          │  ・ドラッグ選択可能                  │
          └────────────────┬────────────────────┘
                          │ 範囲選択完了
                          ▼
          ┌─────────────────────────────────────┐
          │          月確認待ち                  │
          │  ・自動検出結果表示                  │
          │  ・手動設定可能                      │
          └────────────────┬────────────────────┘
                          │ 月確認OK
                          ▼
          ┌─────────────────────────────────────┐
          │          生成準備完了                │
          │  ・コメント設定可能                  │
          │  ・生成ボタン有効                    │
          └────────────────┬────────────────────┘
                          │ 生成ボタンクリック
                          ▼
          ┌─────────────────────────────────────┐
          │          生成中                      │
          │  ・ローディング表示                  │
          │  ・キャンセル可能                    │
          └────────────────┬────────────────────┘
                          │ 生成完了
                          ▼
          ┌─────────────────────────────────────┐
          │          コメント表示                │
          │  ・編集可能                          │
          │  ・コピー可能                        │
          │  ・再生成可能                        │
          └─────────────────────────────────────┘
                          │
              ┌───────────┼───────────┐
              ▼           ▼           ▼
        別範囲選択   別シート選択   新規ファイル
              │           │           │
              └───────────┴───────────┘
                          │
                    ループ（繰り返し）
```

---

*作成日: 2025-12-16*
*バージョン: 1.0*
