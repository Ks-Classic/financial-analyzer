# 財務コメント自動生成機能 - 実装計画書

## 1. 開発スケジュール概要

```
Week 1-2: Phase 1 MVP 基盤
Week 3:   Phase 1 MVP 仕上げ・テスト
Week 4-5: Phase 2 テンプレート機能
Week 6:   Phase 2 テスト・改善
Week 7-8: Phase 3 高度機能（オプション）
```

---

## 2. Phase 1: MVP (2-3週間)

### 2.1 Week 1: 基盤構築

#### Day 1-2: プロジェクトセットアップ
- [ ] 新規コンポーネント用ディレクトリ作成
- [ ] `xlsx` ライブラリ導入
- [ ] 型定義ファイル作成 (`types/comment-generator.ts`)
- [ ] メニュータブ追加（App.tsx修正）

#### Day 3-4: Excelアップロード・パース
- [ ] `FileUploader.tsx` コンポーネント作成
- [ ] `useExcelParser.ts` フック作成
- [ ] ドラッグ＆ドロップ対応
- [ ] バリデーション実装

#### Day 5: シート選択
- [ ] `SheetSelector.tsx` コンポーネント作成
- [ ] シート一覧表示
- [ ] シート選択時のプレビューデータ取得

### 2.2 Week 2: コア機能実装

#### Day 1-2: スプレッドシートビューア
- [ ] `SpreadsheetViewer.tsx` コンポーネント作成
- [ ] セルグリッド表示
- [ ] 行番号・列ヘッダー表示
- [ ] スクロール対応

#### Day 3-4: 範囲選択
- [ ] `RangeSelector.tsx` コンポーネント作成
- [ ] ドラッグ選択ロジック (`useRangeSelection.ts`)
- [ ] 選択範囲ハイライト表示
- [ ] 選択データ抽出

#### Day 5: 月列検出
- [ ] `MonthDetector.tsx` コンポーネント作成
- [ ] `useMonthDetection.ts` フック作成
- [ ] パターンマッチング実装
- [ ] 検出結果確認UI

### 2.3 Week 3: AI連携・仕上げ

#### Day 1-2: バックエンドAPI
- [ ] `/api/generate-comment` エンドポイント作成
- [ ] プロンプト設計・実装
- [ ] Gemini API連携
- [ ] レスポンス整形

#### Day 3: フロントエンド連携
- [ ] `useCommentGeneration.ts` フック作成
- [ ] API呼び出し実装
- [ ] ローディング・エラー表示

#### Day 4: コメント表示・編集
- [ ] `CommentEditor.tsx` コンポーネント作成
- [ ] 編集モード切り替え
- [ ] コピー機能実装

#### Day 5: テスト・修正
- [ ] E2Eテスト作成
- [ ] バグ修正
- [ ] パフォーマンス確認

---

## 3. Phase 2: テンプレート機能 (2-3週間)

### 3.1 Week 4: 顧客管理

#### Day 1-2: Firestoreセットアップ
- [ ] コレクション作成
- [ ] セキュリティルール設定
- [ ] Firebase SDK設定

#### Day 3-4: 顧客CRUD
- [ ] 顧客管理画面作成
- [ ] 顧客一覧表示
- [ ] 新規登録フォーム
- [ ] 編集・削除機能

#### Day 5: 顧客選択連携
- [ ] コメント生成画面に顧客選択追加
- [ ] 顧客情報の読み込み

### 3.2 Week 5: テンプレート管理

#### Day 1-2: テンプレート設定
- [ ] ページ一覧画面
- [ ] テンプレート登録フォーム
- [ ] 範囲設定保存

#### Day 3-4: テンプレート適用
- [ ] テンプレート自動マッピング
- [ ] 月列動的検出
- [ ] 設定確認UI

#### Day 5: 一括生成
- [ ] 複数ページコメント一括生成
- [ ] 進捗表示
- [ ] 結果一覧表示

### 3.3 Week 6: 改善・テスト
- [ ] UX改善
- [ ] パフォーマンス最適化
- [ ] 本番環境テスト

---

## 4. タスク詳細

### 4.1 T1-01: メニュータブ追加

**ファイル**: `src/App.tsx`

**変更内容**:
```tsx
// タブ定義に追加
const tabs = [
  { id: 'report-check', label: 'レポートチェック' },
  { id: 'comment-generator', label: 'コメント生成' },  // NEW
];

// タブコンテンツに追加
{activeTab === 'comment-generator' && <CommentGeneratorTab />}
```

**完了条件**:
- コメント生成タブが表示される
- タブ切り替えが動作する

---

### 4.2 T1-02: Excelパーサー実装

**ファイル**: `src/hooks/useExcelParser.ts`

**実装内容**:
- `xlsx` を使用したファイル読み込み
- シート一覧取得
- シートデータ取得

**完了条件**:
- xlsxファイルをパースできる
- シート名一覧を取得できる
- 任意のシートのセルデータを取得できる

---

### 4.3 T1-03: 範囲選択UI実装

**ファイル**: `src/components/comment-generator/RangeSelector.tsx`

**実装内容**:
- マウスイベントハンドリング
- 選択範囲の視覚化
- 選択データの抽出

**完了条件**:
- ドラッグで範囲選択できる
- 選択範囲がハイライト表示される
- 選択範囲の情報（行・列）が表示される

---

## 5. 依存関係

```
T1-01 (タブ追加)
   │
   ▼
T1-02 (Excelパーサー)
   │
   ├──▶ T1-03 (範囲選択)
   │       │
   │       ▼
   │    T1-04 (月検出)
   │
   ▼
T1-05 (API実装)
   │
   ▼
T1-06 (コメント表示)
   │
   ▼
T1-07 (コピー機能)
```

---

## 6. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Excelの多様なフォーマット | 高 | 主要パターンを先に対応、エッジケースは後回し |
| AI生成品質 | 高 | プロンプトを繰り返し調整、人間編集を前提 |
| 範囲選択UIの複雑さ | 中 | シンプルな実装から開始、段階的に改善 |

---

## 7. 成果物チェックリスト

### Phase 1 完了時
- [ ] Excelアップロード動作
- [ ] シート選択動作
- [ ] 範囲選択動作
- [ ] 月列検出動作
- [ ] コメント生成動作
- [ ] コピー機能動作
- [ ] エラーハンドリング完了
- [ ] 本番デプロイ完了

### Phase 2 完了時
- [ ] 顧客管理機能動作
- [ ] テンプレート保存動作
- [ ] テンプレート適用動作
- [ ] 一括生成動作
- [ ] Firestore連携完了

---

*作成日: 2025-12-16*
