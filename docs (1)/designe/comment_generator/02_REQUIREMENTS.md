# 財務コメント自動生成機能 - 要件定義書

## 1. 機能要件一覧

### 1.1 Phase 1（MVP）機能

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F1-01 | Excelアップロード | xlsx/xlsファイルをアップロード | 必須 |
| F1-02 | シート一覧表示 | アップロードしたExcelのシート一覧を表示 | 必須 |
| F1-03 | シートプレビュー | 選択したシートの内容を表形式で表示 | 必須 |
| F1-04 | 範囲選択 | 分析対象の表範囲をドラッグで選択 | 必須 |
| F1-05 | 月列自動検出 | ヘッダー行から月情報（YYMM等）を自動検出 | 必須 |
| F1-06 | 対象月確認UI | 検出した最新月/前月を表示・確認 | 必須 |
| F1-07 | コメント生成 | AIによる財務分析コメント生成 | 必須 |
| F1-08 | コメント編集 | 生成されたコメントを編集可能 | 必須 |
| F1-09 | コメントコピー | コメントをクリップボードにコピー | 必須 |
| F1-10 | 表コピー | 選択範囲の表をクリップボードにコピー | 必須 |
| F1-11 | メニュー追加 | 既存アプリにコメント生成メニューを追加 | 必須 |

### 1.2 Phase 2 機能

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F2-01 | 顧客登録 | 顧客情報の登録・編集・削除 | 必須 |
| F2-02 | 顧客選択 | コメント生成時に顧客を選択 | 必須 |
| F2-03 | テンプレート保存 | 範囲設定・コメント設定を保存 | 必須 |
| F2-04 | テンプレート適用 | 保存済テンプレートを自動適用 | 必須 |
| F2-05 | ページ管理 | 顧客ごとのページ（20P）を管理 | 必須 |
| F2-06 | コメント設定 | 項目、文字数、改行ルール設定 | 推奨 |
| F2-07 | 一括生成 | 複数ページのコメントを一括生成 | 推奨 |

### 1.3 Phase 3 機能

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F3-01 | 項目選択UI | コメント対象項目を選択可能 | 推奨 |
| F3-02 | 優先項目サジェスト | 変動が大きい項目を推奨表示 | 推奨 |
| F3-03 | 管理画面 | テンプレート設定のGUI編集 | 推奨 |
| F3-04 | 未来予測対応 | 予測財務諸表のコメント生成 | 推奨 |
| F3-05 | 履歴管理 | 生成したコメントの履歴保存 | 任意 |

---

## 2. 機能詳細仕様

### F1-01: Excelアップロード

#### 概要
ユーザーがローカルのExcelファイルをアップロードする機能

#### 入力
- ファイル形式: `.xlsx`, `.xls`
- ファイルサイズ上限: 50MB
- 複数シート対応: 必須

#### 処理
1. ファイル形式バリデーション
2. ファイルサイズチェック
3. `xlsx`ライブラリでパース
4. シート一覧を抽出
5. メモリ上に保持（DBには保存しない）

#### 出力
- シート名一覧
- 各シートの行数・列数

#### エラーケース
| エラー | メッセージ |
|--------|-----------|
| 非対応形式 | 「xlsx または xls ファイルをアップロードしてください」 |
| サイズ超過 | 「ファイルサイズが50MBを超えています」 |
| 破損ファイル | 「ファイルを読み込めませんでした」 |

---

### F1-04: 範囲選択

#### 概要
シートプレビュー上でマウスドラッグにより分析対象範囲を選択

#### 入力
- マウスドラッグ開始位置（セルアドレス）
- マウスドラッグ終了位置（セルアドレス）

#### 処理
1. ドラッグ開始セルを記録
2. マウス移動に応じて選択範囲をハイライト表示
3. ドラッグ終了時に範囲を確定
4. 選択範囲のデータを抽出

#### 出力
- 選択範囲: `{startRow, endRow, startCol, endCol}`
- 選択範囲のセルデータ（2次元配列）

#### UI仕様
- 選択中: 半透明の青色オーバーレイ
- 確定後: 枠線でハイライト
- 範囲変更: 再度ドラッグで上書き
- 複数範囲: 同一シートで複数の範囲を定義可能（Phase 2）

---

### F1-05: 月列自動検出

#### 概要
ヘッダー行から月情報を自動認識し、最新月・比較対象月を特定

#### 対応パターン

| パターン | 例 | 正規表現 |
|----------|-----|---------|
| YYMM | 2506, 2505 | `/^(\d{4})$/` |
| YYYY/MM | 2025/06 | `/^(\d{4})\/(\d{2})$/` |
| YYYY-MM | 2025-06 | `/^(\d{4})-(\d{2})$/` |
| N月 | 6月, 12月 | `/^(\d{1,2})月$/` |
| 実績_YYMM | 実績_2506 | `/^実績[_\s]?(\d{4})$/` |

#### 処理
1. 指定されたヘッダー行を取得
2. 各セルに対してパターンマッチング
3. マッチしたセルを月情報として抽出
4. 日付順にソート
5. 最新月を特定
6. 比較対象月（前月）を特定

#### 出力
```typescript
{
  detectedMonths: string[];       // ['2501', '2502', ..., '2506']
  latestMonth: string;            // '2506'
  previousMonth: string;          // '2505'
  latestMonthColumn: number;      // 列インデックス
  previousMonthColumn: number;    // 列インデックス
  pattern: string;                // 検出したパターン名
}
```

#### エラーケース
| ケース | 対応 |
|--------|------|
| パターン検出失敗 | 「月情報を検出できませんでした。ヘッダー行を確認してください」 |
| 月が1つのみ | 「比較対象月がありません。単月分析モードで続行しますか？」 |

---

### F1-07: コメント生成

#### 概要
選択範囲のデータをAI（Gemini API）に送信し、財務分析コメントを生成

#### 入力
```typescript
{
  tableData: {
    headers: string[];
    rows: {
      item: string;
      values: {
        month: string;
        value: number | string;
      }[];
    }[];
  };
  targetMonth: string;
  compareMonth: string;
  pageType?: string;          // 'income_statement', 'balance_sheet', etc.
  targetItems?: string[];     // 指定項目（省略時はお任せ）
  commentStyle?: {
    maxLength?: number;
    format?: 'bullet' | 'paragraph';
  };
}
```

#### 処理
1. 入力データをAIプロンプトに整形
2. Gemini APIにリクエスト送信
3. レスポンスをパース
4. コメントと分析ハイライトを抽出

#### 出力
```typescript
{
  comment: string;              // 生成されたコメント（整形済み）
  highlights: {
    item: string;               // 項目名
    currentValue: number;       // 当月値
    previousValue: number;      // 前月値
    changeAmount: number;       // 変動額
    changeRate: number;         // 変動率（%）
    description: string;        // 変動の説明
  }[];
  suggestedItems: string[];     // 推奨分析項目
  confidence: number;           // 信頼度スコア
}
```

#### 生成コメントの期待形式
```
・売上高
  5月は単価が増加したものの、ミラクルフィットⅠ（片側）やミラクルフィットⅤ
  （コバルト）等の販売個数が減少したことにより、売上高は対前月比で減少している。

・売上高
  - ラボ：歯科技工物であるミラクルデンチャーに係る売上高である。
  - 5月は単価が増加したものの、4月の季節的な需要回復要因がなくなった影響で...
```

---

## 3. 非機能要件

### 3.1 性能要件

| 項目 | 要件 |
|------|------|
| Excelアップロード | 10MB以下: 3秒以内 |
| シートプレビュー表示 | 1000行以下: 1秒以内 |
| 範囲選択レスポンス | 100ms以内 |
| コメント生成 | 30秒以内 |
| コピー操作 | 即時 |

### 3.2 対応環境

| 項目 | 対応範囲 |
|------|---------|
| ブラウザ | Chrome (最新2バージョン), Edge, Firefox |
| 画面サイズ | 1280px以上推奨、1024px以上で動作 |
| Excel形式 | xlsx (Office 2007以降), xls |

### 3.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| データ保存 | アップロードしたExcelはサーバーに保存しない |
| 通信 | HTTPS必須 |
| APIキー | 環境変数で管理、クライアントに露出しない |

### 3.4 可用性

| 項目 | 要件 |
|------|------|
| 稼働時間 | 平日 9:00-21:00 は99%以上 |
| 障害復旧 | 4時間以内 |

---

## 4. ユースケース

### UC-01: 基本的なコメント生成

**アクター**: 財務レポート担当者
**事前条件**: ユーザーがアプリにアクセスしている
**トリガー**: Excelファイルの準備完了

**メインフロー**:
1. ユーザーが「コメント生成」メニューを選択
2. システムがコメント生成画面を表示
3. ユーザーがExcelファイルをドラッグ＆ドロップ
4. システムがファイルを解析し、シート一覧を表示
5. ユーザーが対象シートを選択
6. システムがシートプレビューを表示
7. ユーザーが分析対象範囲をドラッグで選択
8. システムが月列を自動検出し、表示
9. ユーザーが「コメント生成」ボタンをクリック
10. システムがAI分析を実行
11. システムがコメントを表示
12. ユーザーが必要に応じてコメントを編集
13. ユーザーが「コピー」ボタンをクリック
14. システムがコメントをクリップボードにコピー
15. ユーザーがパワポに貼り付け

**代替フロー**:
- 4a. ファイル形式エラー → エラーメッセージ表示、1に戻る
- 8a. 月列検出失敗 → 手動設定UIを表示
- 10a. AI生成失敗 → エラーメッセージ、リトライオプション表示

**事後条件**: コメントがクリップボードにコピーされている

---

### UC-02: 複数ページのコメント生成（Phase 2）

**アクター**: 財務レポート担当者
**事前条件**: 顧客テンプレートが登録済み

**メインフロー**:
1. ユーザーが顧客を選択
2. ユーザーがExcelファイルをアップロード
3. システムがテンプレートに基づき範囲を自動設定
4. ユーザーが設定を確認
5. ユーザーが「全ページ生成」をクリック
6. システムが各ページのコメントを順次生成
7. ユーザーが各ページのコメントを確認・編集
8. ユーザーが各ページをコピー→パワポ貼り付け

---

## 5. 画面遷移

```
┌──────────────────┐
│  トップページ    │
│  [レポートチェック]
│  [コメント生成] ──────────────┐
│  [顧客管理]                  │
└──────────────────┘           │
                              ▼
                    ┌─────────────────────┐
                    │ コメント生成画面     │
                    │ ┌─────────────────┐ │
                    │ │ ファイルアップ  │ │
                    │ │ ロード          │ │
                    │ └─────────────────┘ │
                    └──────────┬──────────┘
                              ▼
                    ┌─────────────────────┐
                    │ シート選択          │
                    │ ┌─────────────────┐ │
                    │ │ シート一覧      │ │
                    │ │ プレビュー      │ │
                    │ └─────────────────┘ │
                    └──────────┬──────────┘
                              ▼
                    ┌─────────────────────┐
                    │ 範囲選択モード      │
                    │ ┌─────────────────┐ │
                    │ │ スプレッドシート│ │
                    │ │ 範囲選択UI      │ │
                    │ └─────────────────┘ │
                    └──────────┬──────────┘
                              ▼
                    ┌─────────────────────┐
                    │ コメント生成・編集  │
                    │ ┌─────────────────┐ │
                    │ │ 表プレビュー    │ │
                    │ │ コメント表示    │ │
                    │ │ コピーボタン    │ │
                    │ └─────────────────┘ │
                    └─────────────────────┘
```

---

## 6. データフロー

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Excel   │───→│ フロント │───→│ バック   │───→│ Gemini   │
│  ファイル │    │ エンド   │    │ エンド   │    │ API      │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                    │                │               │
                    │                │               │
                ┌───┴───┐        ┌───┴───┐      ┌───┴───┐
                │ xlsx  │        │ テーブル │      │ コメント │
                │ パース │        │ データ   │      │ 生成     │
                └───────┘        └─────────┘      └─────────┘
                    │                │               │
                    ▼                ▼               ▼
            ┌───────────┐    ┌───────────┐    ┌───────────┐
            │ シート    │    │ 選択範囲   │    │ 生成      │
            │ プレビュー │    │ データ     │    │ コメント  │
            └───────────┘    └───────────┘    └───────────┘
```

---

## 7. 外部インターフェース

### 7.1 Gemini API

- エンドポイント: `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent`
- 認証: API Key（環境変数）
- レート制限: 60 requests/minute

### 7.2 クリップボードAPI

- `navigator.clipboard.writeText()` - テキストコピー
- `navigator.clipboard.write()` - リッチテキストコピー（将来）

---

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| ページ | パワーポイントの1スライドに対応する単位 |
| テンプレート | 顧客×ページの設定情報（範囲、コメント形式等） |
| 範囲 | Excel上の選択されたセル範囲 |
| 月列 | 月情報（2506等）が記載されている列 |
| 項目 | 財務諸表の勘定科目（売上高、売上原価等） |

---

*作成日: 2025-12-16*
*バージョン: 1.0*
