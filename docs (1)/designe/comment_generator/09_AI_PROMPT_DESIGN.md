# 財務コメント自動生成機能 - AIプロンプト設計書

## 1. プロンプト設計方針

### 1.1 設計原則
1. **明確な役割設定**: AIに財務アナリストとしての役割を与える
2. **構造化された入力**: 表データをJSON形式で明確に提供
3. **出力フォーマット指定**: 期待する出力形式を厳密に指定
4. **コンテキスト提供**: 分析観点、対象月を明示

### 1.2 プロンプト構成

```
[システム指示]
↓
[入力データ]
↓
[分析観点]
↓
[出力フォーマット指示]
↓
[制約条件]
```

---

## 2. メインプロンプト

### 2.1 システムプロンプト

```
あなたは財務分析の専門家です。企業の財務データを分析し、経営者向けの簡潔で洞察に富んだコメントを作成してください。

分析の際は以下の点に注意してください：
- 数値の変動を正確に把握し、主要な変動要因を特定する
- 前月比での増減を明確に示す
- 経営判断に役立つ洞察を提供する
- 専門用語は適切に使用しつつ、わかりやすい表現を心がける
```

### 2.2 ユーザープロンプトテンプレート

```typescript
function buildCommentPrompt(params: PromptParams): string {
  return `
## 分析対象データ

以下は${params.targetMonth}月の財務データです。前月（${params.compareMonth}月）と比較して分析してください。

### 表データ
\`\`\`json
${JSON.stringify(params.tableData, null, 2)}
\`\`\`

### 変動サマリー
${params.highlights.map(h => 
  `- ${h.item}: ${h.previousValue} → ${h.currentValue} (${h.changeRate > 0 ? '+' : ''}${h.changeRate.toFixed(1)}%)`
).join('\n')}

## 分析対象項目
${params.targetItems ? params.targetItems.join(', ') : '全項目を分析してください'}

## 出力形式
以下の形式でコメントを作成してください：

・{項目名}
  {当月の状況と前月比の変動についての説明}
  {変動の主な要因や背景}

## 制約条件
- 各項目は100〜150文字程度で簡潔に
- 箇条書き形式で出力
- 数値は千円単位で表記（例: 21,080千円）
- 変動率は小数点1桁まで表記（例: +17.1%）
`.trim();
}
```

---

## 3. ページタイプ別プロンプト補足

### 3.1 損益計算書 (income_statement)

```
追加の分析観点:
- 売上高の増減要因（数量・単価の変動）
- 売上総利益率の変化
- 販管費の効率性
- 営業利益率の推移
```

### 3.2 貸借対照表 (balance_sheet)

```
追加の分析観点:
- 流動資産・負債のバランス
- 運転資本の変動
- 有利子負債の推移
- 自己資本比率の変化
```

### 3.3 資金繰り (cash_flow)

```
追加の分析観点:
- 資金収支のボトム・ピーク
- 主な入金・出金イベント
- 資金余裕度の評価
- 将来の資金需要への示唆
```

### 3.4 スタッフ別売上 (staff_sales)

```
追加の分析観点:
- 上位・下位パフォーマーの特定
- 平均売上との比較
- 前月比での成長・減少
- 人件費率との関連
```

---

## 4. 出力パース処理

### 4.1 期待される出力形式

```
・売上高
  2506月の売上高は21,080千円となり、前月比+17.1%（+3,071千円）の増加。
  主にラボ売上の回復（前月比+15.9%）が寄与している。

・入会金収入
  前月0円から340千円へ増加。新規MD会員の入会によるもの。
  グレードアップ会員からの入会金が含まれる。
```

### 4.2 パース関数

```typescript
function parseAIResponse(response: string): ParsedComment {
  // 項目ごとに分割
  const sections = response.split(/^・/m).filter(Boolean);
  
  const items: CommentItem[] = sections.map(section => {
    const lines = section.split('\n').map(l => l.trim());
    const itemName = lines[0];
    const content = lines.slice(1).join('\n').trim();
    
    return { itemName, content };
  });
  
  return {
    comment: response,
    items,
  };
}
```

---

## 5. プロンプト改善のためのフィードバックループ

### 5.1 品質評価基準

| 基準 | 評価ポイント |
|------|-------------|
| 正確性 | 数値が正しいか、計算が合っているか |
| 洞察性 | 単なる数値羅列でなく洞察があるか |
| 簡潔性 | 冗長でなく簡潔にまとまっているか |
| フォーマット | 指定した形式に従っているか |

### 5.2 改善サイクル

```
生成 → 人間レビュー → 課題特定 → プロンプト修正 → 再生成
```

---

## 6. Few-shot Examples

プロンプトに含める参考例:

```
## 参考出力例

### 入力データ（一部）
- 売上高: 18,009千円 → 21,080千円
- ラボ: 17,806千円 → 20,634千円
- 入会金収入: 0千円 → 340千円

### 期待する出力
・売上高
  2506月の売上高は21,080千円となり、前月比+17.1%（+3,071千円）の増加。
  主にラボ売上の回復（前月比+15.9%）が寄与している。ラボは歯科技工物である
  ミラクルデンチャーに係る売上高であり、季節的な需要変動から回復した。

・入会金収入
  前月0円から340千円へ増加。新規MD会員の入会によるもの。
  グレードアップ会員からの入会金（10万円）が含まれており、
  ミラクルラボの取り分（20%）である。
```

---

## 7. エラーハンドリング

### 7.1 AI出力が不正な場合

```typescript
function validateAIOutput(output: string): ValidationResult {
  // 最低限の形式チェック
  if (!output.includes('・')) {
    return { valid: false, error: '箇条書き形式でありません' };
  }
  
  if (output.length < 50) {
    return { valid: false, error: '出力が短すぎます' };
  }
  
  return { valid: true };
}
```

### 7.2 リトライ戦略

1. 初回失敗: プロンプトを簡略化して再試行
2. 2回目失敗: デフォルトのテンプレート回答を返却
3. 3回目失敗: エラーを返却

---

*作成日: 2025-12-16*
