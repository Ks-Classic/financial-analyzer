# 05. プロンプト設計

## 概要

AIコメント生成の品質はプロンプト設計に大きく依存する。
本ドキュメントでは、使用しているプロンプト構造と最適化ポイントを説明。

---

## プロンプト構造

### 2層構造

```
┌─────────────────────────────────────────────────────┐
│ システムプロンプト（全ページ共通）                  │
│ - AIの役割定義                                      │
│ - 出力フォーマット                                  │
│ - 共通ルール                                        │
└─────────────────────────────────────────────────────┘
                        ＋
┌─────────────────────────────────────────────────────┐
│ ページプロンプト（ページ固有）                      │
│ - 分析の焦点                                        │
│ - 注目ポイント                                      │
│ - 特記事項                                          │
└─────────────────────────────────────────────────────┘
```

---

## デフォルトシステムプロンプト

```markdown
あなたは財務レポートの専門家です。
提供された画像から、経営報告用のコメントを生成してください。

【分析対象】
- {pageTitle}（ページ{pageNumber}）

【出力ルール】
1. 客観的な数値分析を含める
2. 前月との比較を行い、変動理由を考察する
3. 重要な変動がある場合は具体的な要因を示す
4. 200-300字程度で簡潔にまとめる
5. 箇条書きは使わず、文章形式で記述する

【前月コメント参考】
{previousComment}

上記を参考に、今月の状況に合わせたコメントを生成してください。
変更点がある場合はそれを明確に示してください。
```

---

## ページ固有プロンプト例

### 貸借対照表
```markdown
【特に注目すべきポイント】
- 総資産・負債・純資産の推移
- 流動/固定比率の変化
- 自己資本比率
- 主要な増減項目とその要因
```

### 損益計算書
```markdown
【特に注目すべきポイント】
- 売上高の前月比・前年比
- 売上総利益率の変化
- 販管費の増減要因
- 営業利益・経常利益の推移
```

### キャッシュフロー計算書
```markdown
【特に注目すべきポイント】
- 営業CF/投資CF/財務CFの状況
- フリーキャッシュフロー
- 現金及び現金同等物の増減
- 資金繰りへの影響
```

---

## 一括生成時のプロンプト

### bulk-cache時のコンテキスト

```typescript
const contents = [
    {
        role: "user",
        parts: [
            { text: systemPrompt },
            // 各ページの画像とメタデータ
            ...pages.flatMap(page => [
                { text: `\n\n【ページ${page.pageNumber}: ${page.pageTitle}】` },
                { inlineData: { mimeType: "image/png", data: imageBase64 } },
                { text: `前月コメント: ${page.previousComment || 'なし'}` },
            ])
        ]
    }
];
```

### generate-fast時のプロンプト

```markdown
上記のキャッシュされた情報を参考に、
ページ{pageNumber}「{pageTitle}」のコメントを生成してください。

【出力形式】
- 200-300字程度
- 文章形式（箇条書き不可）
- 前月との比較を含める
- 変動要因を考察する

{pagePrompt}

コメントのみを出力してください。説明や前置きは不要です。
```

---

## チャット修正時のプロンプト

```markdown
【現在のコメント】
{currentComment}

【修正指示】
{userInstruction}

上記の指示に従って、現在のコメントを修正してください。
修正後のコメントのみを出力してください。
```

---

## 修正タイプ別プロンプト

| タイプ | プロンプト |
|--------|----------|
| `shorten` | コメントをより簡潔に要約してください。重要なポイントを維持しながら、文字数を半分程度に減らしてください。 |
| `detailed` | コメントをより詳細にしてください。数値分析を深堀りし、変動要因の考察を追加してください。 |
| `formal` | コメントをよりフォーマルな文体に変換してください。経営会議での報告に適した表現を使用してください。 |
| `casual` | コメントをより読みやすい文体に変換してください。専門用語を減らし、誰にでも理解しやすい表現にしてください。 |
| `custom` | ユーザーの自由記述による指示 |

---

## 最適化のポイント

### 1. 明確な役割定義

```markdown
❌ 悪い例: コメントを書いてください
✅ 良い例: あなたは財務レポートの専門家です。経営層向けの報告用コメントを生成してください。
```

### 2. 具体的な出力形式

```markdown
❌ 悪い例: 適切な長さで
✅ 良い例: 200-300字程度で、文章形式（箇条書き不可）
```

### 3. コンテキストの活用

```markdown
❌ 悪い例: 画像を分析してください
✅ 良い例: 
  【分析対象】貸借対照表（ページ1）
  【前月コメント】...
  上記を参考に、今月の変化を踏まえたコメントを生成してください。
```

### 4. 不要な出力の抑制

```markdown
❌ → AIが「はい、わかりました。」などを出力
✅ 良い例: コメントのみを出力してください。説明や前置きは不要です。
```

---

## トラブルシューティング

| 問題 | 原因 | 対策 |
|------|------|------|
| 出力が長すぎる | 文字数制限が不明確 | 「200字以内」と明示 |
| 出力が抽象的 | 具体性の指示不足 | 「具体的な数値を含めて」と指示 |
| 前月比較がない | 前月データの活用不足 | 前月コメントを明示的に含める |
| 不要な前置き | 出力制御不足 | 「コメントのみ出力。説明不要」 |

---

## モデル設定

- **モデル**: `gemini-3-flash-preview`
- **temperature**: 0.7（適度な創造性）
- **topP**: 0.95
- **maxOutputTokens**: 1024
